# NJM Server

Node.js GraphQL backend for Next.js Masters course. Provides mock e-commerce data for demo record store. 
GraphQL API is based on Apollo server wrapped as Express.js middleware. 

## Running in development

- Start DB container & admin panel: `docker-compose -f docker-compose-dev.yaml up adminer db`.
- DB admin panel @ _localhost:8080_, user: _admin_, pass: _password_.
- Start Node server in hot reload (Nodemon): `npm run dev`.

## Codegen for GraphQL

Based on _@graphql-codegen/cli_ package with <https://www.npmjs.com/package/@eddeee888/gcg-typescript-resolver-files> plugin for more opinionated setup.

- `pnpm codegen` to create/update GraphQL resolvers based on schema changes.
- `DATABASE_URL=postgresql://admin:password@localhost:5432/njm pnpm exec prisma migrate dev` to update migrations locally.
- `pnpm exec prisma generate` to init/refresh prisma client.
- `DATABASE_URL=postgresql://admin:password@localhost:5432/njm pnpm exec ts-node prisma/seed.ts` to manage initial test data. Use `--drop` to clean all existing data.
Use `--seed` to create mock data. See _mock data generator_ for details.

## Mock data generator

Data for app testing is provided by [Spotify API](https://developer.spotify.com/documentation/web-api) - store items are bulk generated by Spotify recommendation engine based on list of arbitrarily selected genres.  

See _prisma/mockdata/_ folder for implementation details.

## Deployment & GitOps

Production server is running on RKE2 Kubernetes. Deployment is automatic on push/merge to _main_ branch - GitOps process runs via GitHub actions and ArgoCD.

Auto deployment workflow:

- Developer PR / push / merge to main.
- GitHub actions CICD pipeline:
  - Automatic build of new Docker image (commit SHA based versioning).
  - Push to GitHub container registry.
  - Automatic update of image tag in Kubernetes manifest - auto-commit to main branch & skip CI option to avoid pipeline loop.
- On main branch update - ArgoCD webhook triggers cluster update.

All production secrets are encrypted using sealed secrets controller - <https://github.com/bitnami-labs/sealed-secrets>.

## CICD & architecture diagram

![image](./architecture.png)

## Configuration

Required settings must be provided in Kubernetes configmaps / secrets.

```shell
# database
POSTGRES_USER
POSTGRES_PASSWORD

# app
DATABASE_USER
DATABASE_PASS
DATABASE_HOST # as "host:port" e.g. db:5432
DATABASE_NAME
NODE_ENV # development || production
NODE_PORT # graphql & rest server port, default 8000
```
